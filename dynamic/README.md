# 针对复杂动态场景的自动判定

> 目前许多超级app都会具备UI动态化的设计，以达到更高的灵活度。在 0.10.0 之后，stagesepx 借助了 keras 来处理该类型问题。

## 背景

这个例子主要针对一些动态生成的特殊场景，例如：

- 内容型APP每次打开首页内容都不一致
- 插屏广告播放的内容是随机的
- 游戏某个阶段场景是动态的（有循环播放的动画等，很多游戏的初始界面都会有）

而单纯靠 SVM classifier 难以很好地处理上述情况（详见 [issue#89](https://github.com/williamfzc/stagesep/issues/89)）。为此，我们引入了神经网络用于处理这些特殊情况。

## 原理

> 假设读者已阅读 [自动测试APP启动速度](../auto) 部分。

利用 神经网络 进行图像分类已经是种非常成熟的技术（可以参考 [面向小数据集构建图像分类模型](https://keras-cn.readthedocs.io/en/latest/legacy/blog/image_classification_using_very_little_data/))，效果也很好。此处不再赘述。

为什么一开始 stagesepx 没有采用这种技术：

- 一方面是神经网络要达到比较好的效果需要更高的成本（更长的时间与更大的训练集），而我们希望的是低依赖且方便快速，不需要过多前置准备；
- 另一方面，就初期需求而言，SVM的表现已经足够好，完全能够胜任单视频情况下的分类工作；
- 至于为什么现在需要神经网络，在背景中有提到；

虽然在构造与原理上 SVM 与神经网络差异很大，但我们在 API 层面上尽可能地保证了该类 classifier 的调用模式相似。

与所有 classifier 相同，它本身与 cutter 并不会有任何耦合，我们可以通过自定义训练集来干预分类的结果。

在调用层面上，流程是一样的：

- 加载数据
- 训练模型
- 应用模型

值得注意的是，它与SVM的表现上有一些差异： 
 
- 默认情况下我们使用 SVM + HOG 的组合进行分类，它表现为（与算法、api的设计都有关）较高的训练效率与较低的预测效率；
- 神经网络的表现是，训练效率较低（耗时更长，算力需求更高）但预测效率较高（模型训练完成后预测速度快）；

## 使用

下面将以抖音的启动为例。

### 前置资源

#### 安装

使用 KerasClassifier 需要 tensorflow 的支持。

```bash
pip install tensorflow
```

其他方式请自行官网查看。

#### 脚本

可以看到当前目录下有三个脚本：

- `get_data.py`：从视频中得到训练集
- `train_model.py`：将训练集转变为模型
- `classify_with_model.py`：用训练好的模型预测新视频

#### 视频

videos 目录下有 6 个视频，均以 douyin 开头。

### 分析

对于抖音来说，启动过程会分为5个阶段（可根据需要自行设计划分）：

- 初始阶段（app没打开）
- 首屏（抖音字样）
- 插屏广告（可能有）
- 应用内首屏（视频未加载，但主体控件已加载完成）
- 应用完成（视频与控件均以加载完成）

那么，我们将根据划分好的阶段对数据集进行处理，并利用处理后的数据集训练模型。

### 流程

> 先确保阅读过 [自动测试APP启动速度](../auto) ，相同处不赘述。keras 训练过程相对较长，在保存形态与流程上会有些许的不同。

对于一个app来说我们需要录制一组视频作为训练集。仓库里有6个，下面将以前三个视频为例介绍。

这次我特意将整个过程拆分成三个脚本，对应了不同的过程，更方便阅读与使用。利用 `get_data.py` 脚本可以将视频处理成训练集，那么，三个视频将可以得到三个文件夹的数据集。**理论上，当数据集越多时，对于动态情况的抵御能力将更强。**

之后进行人工分拣，将训练集整合成一个文件夹。在确保每个阶段都符合你的预期之后，执行 `train_model.py` 将数据集训练为模型（权重）并保存。在训练完成后你将可以看到 `keras_model.h5` 文件，即为你的模型权重。

有了模型之后，你将可以利用 `classify_with_model.py` 对新视频进行分析，而新视频的分类将根据你希望的分类进行。

> 1、2、3视频中无插屏广告，可用4、5、6代替。

### 一些注意的点

你可以发现，似乎整个流程跟以前的版本没有差别。实际上是的，两种 classifier 在 api 与表现上并不会有太大差别。

动态情景下最大的问题是，每个阶段的表现可能是不相同的。以插屏广告为例，每次打开时插屏广告都不一样，此时我们需要扩大训练集，尽量让模型找到广告之间的共性，能够正确地将他们划分到同一类别。

## 相关

https://testerhome.com/topics/22215
